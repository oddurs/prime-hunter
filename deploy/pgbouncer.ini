; PgBouncer configuration for darkreach
;
; Transaction-mode pooling reduces connection overhead from workers and
; the dashboard. Compatible with sqlx because statement_cache_capacity(0)
; is already set in src/db/mod.rs.
;
; Architecture:
;   Workers/Dashboard → PgBouncer:6432 → PostgreSQL:5432

[databases]
darkreach = host=127.0.0.1 port=5432 dbname=darkreach

[pgbouncer]
; Transaction mode: connections are returned to pool after each transaction.
; Compatible with sqlx's statement_cache_capacity(0).
pool_mode = transaction

; Connection limits
default_pool_size = 20
max_client_conn = 200
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 3

; Listen on all interfaces (workers connect remotely)
listen_addr = *
listen_port = 6432

; Authentication
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

; Logging
logfile = /var/log/pgbouncer/pgbouncer.log
log_connections = 0
log_disconnections = 0
log_pooler_errors = 1
stats_period = 60

; Timeouts
server_idle_timeout = 300
client_idle_timeout = 0
server_connect_timeout = 15
query_timeout = 30
query_wait_timeout = 120

; Admin access for monitoring
admin_users = darkreach
stats_users = darkreach

; Connection cleanup
server_reset_query = DISCARD ALL
server_check_query = SELECT 1
server_check_delay = 30
