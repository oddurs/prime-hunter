# PostgreSQL configuration for darkreach self-hosted deployment
# Tuned for CX32 (8 vCPUs, 32 GB RAM, SSD)
#
# Key optimizations over default Supabase:
# - Larger shared_buffers (25% of RAM)
# - Higher work_mem for complex aggregation queries
# - WAL-level replica for streaming replication (Phase 4)
# - TimescaleDB for time-series metric storage

# ── Connection Settings ──────────────────────────────────────────
listen_addresses = '*'
port = 5432
max_connections = 200

# ── Memory ───────────────────────────────────────────────────────
# 25% of 32 GB RAM
shared_buffers = 8GB
# Per-operation sort/hash memory (dashboard aggregations, leaderboard CTEs)
work_mem = 64MB
# Maintenance operations (VACUUM, CREATE INDEX, REFRESH MATERIALIZED VIEW)
maintenance_work_mem = 1GB
# OS page cache is the remaining 24 GB
effective_cache_size = 24GB

# ── WAL / Replication ────────────────────────────────────────────
# replica level required for streaming replication (Phase 4)
wal_level = replica
max_wal_senders = 5
max_replication_slots = 5
# 1 GB WAL retention for replica catch-up
wal_keep_size = 1GB
# Checkpoint every 15 minutes or 1 GB of WAL
checkpoint_timeout = 15min
max_wal_size = 2GB

# ── Query Planner ────────────────────────────────────────────────
# SSD storage: random I/O is nearly as fast as sequential
random_page_cost = 1.1
effective_io_concurrency = 200

# ── Logging ──────────────────────────────────────────────────────
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_statement = 'ddl'

# ── Extensions ───────────────────────────────────────────────────
shared_preload_libraries = 'timescaledb,pg_stat_statements'

# ── Autovacuum ───────────────────────────────────────────────────
autovacuum_max_workers = 4
autovacuum_naptime = 30s
# More aggressive on metric_samples (high-churn table)
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.02
