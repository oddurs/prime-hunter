<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>darkreach dashboard</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #0d1117; color: #c9d1d9; line-height: 1.5;
    padding: 1.5rem; max-width: 1100px; margin: 0 auto;
  }
  header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1.5rem; border-bottom: 1px solid #21262d; padding-bottom: 1rem; }
  header h1 { font-size: 1.4rem; color: #58a6ff; font-weight: 600; }
  header .conn { font-size: 0.8rem; display: flex; align-items: center; gap: 0.4rem; }
  .conn-dot { width: 8px; height: 8px; border-radius: 50%; }
  .conn-dot.ok { background: #3fb950; }
  .conn-dot.off { background: #f85149; }
  .conn-label { color: #8b949e; }

  .status-bar {
    background: #161b22; border: 1px solid #21262d; border-radius: 6px;
    padding: 0.75rem 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;
  }
  .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .status-dot.active { background: #3fb950; box-shadow: 0 0 6px #3fb950; }
  .status-dot.idle { background: #8b949e; }
  .status-text { font-size: 0.85rem; }
  .status-text strong { color: #e6edf3; }

  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
  .card {
    background: #161b22; border: 1px solid #21262d; border-radius: 6px; padding: 1rem;
  }
  .card .label { font-size: 0.75rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.05em; }
  .card .value { font-size: 1.6rem; font-weight: 600; color: #e6edf3; margin-top: 0.25rem; }
  .card .sub { font-size: 0.8rem; color: #8b949e; margin-top: 0.25rem; word-break: break-all; }

  .form-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
  .form-tag {
    background: #21262d; border-radius: 12px; padding: 0.2rem 0.6rem;
    font-size: 0.75rem; color: #c9d1d9;
  }
  .form-tag .count { color: #58a6ff; font-weight: 600; margin-left: 0.3rem; }

  .filter-bar {
    display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; margin-bottom: 1rem;
  }
  .filter-bar input, .filter-bar select {
    background: #161b22; border: 1px solid #30363d; color: #c9d1d9;
    border-radius: 6px; padding: 0.4rem 0.6rem; font-size: 0.8rem;
  }
  .filter-bar input { flex: 1; min-width: 180px; max-width: 280px; }
  .filter-bar input::placeholder { color: #484f58; }
  .filter-bar select { min-width: 140px; }
  .filter-bar button {
    background: #21262d; border: 1px solid #30363d; color: #c9d1d9; border-radius: 6px;
    padding: 0.4rem 0.8rem; cursor: pointer; font-size: 0.8rem;
  }
  .filter-bar button:hover { background: #30363d; }
  .filter-bar .clear-btn { border: none; background: none; color: #8b949e; cursor: pointer; font-size: 0.8rem; }
  .filter-bar .clear-btn:hover { color: #c9d1d9; }

  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  thead th {
    text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid #21262d;
    color: #8b949e; font-weight: 500; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
    cursor: pointer; user-select: none;
  }
  thead th:hover { color: #c9d1d9; }
  thead th .sort-indicator { font-size: 0.7rem; margin-left: 0.3rem; }
  tbody td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #161b22; }
  tbody tr:hover { background: #161b22; }
  .expression { font-family: "SF Mono", SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace; color: #58a6ff; }
  .form-badge {
    display: inline-block; background: #21262d; border-radius: 4px;
    padding: 0.1rem 0.4rem; font-size: 0.75rem;
  }

  .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem; }
  .pagination button {
    background: #21262d; border: 1px solid #30363d; color: #c9d1d9; border-radius: 6px;
    padding: 0.4rem 0.8rem; cursor: pointer; font-size: 0.8rem;
  }
  .pagination button:hover:not(:disabled) { background: #30363d; }
  .pagination button:disabled { opacity: 0.4; cursor: default; }
  .pagination .info { font-size: 0.8rem; color: #8b949e; }

  .section-title { font-size: 1rem; font-weight: 600; color: #e6edf3; margin-bottom: 0.75rem; }
  .empty { text-align: center; padding: 2rem; color: #8b949e; }
</style>
</head>
<body>

<header>
  <h1>darkreach dashboard</h1>
  <span class="conn">
    <span class="conn-dot off" id="connDot"></span>
    <span class="conn-label" id="connLabel">Connecting...</span>
  </span>
</header>

<div class="status-bar" id="statusBar">
  <div class="status-dot idle" id="statusDot"></div>
  <span class="status-text" id="statusText">Waiting for data...</span>
</div>

<div class="cards">
  <div class="card">
    <div class="label">Total primes found</div>
    <div class="value" id="totalPrimes">-</div>
  </div>
  <div class="card">
    <div class="label">Largest prime</div>
    <div class="value" id="largestDigits">-</div>
    <div class="sub" id="largestExpr"></div>
  </div>
  <div class="card">
    <div class="label">By form</div>
    <div class="form-tags" id="formTags">-</div>
  </div>
</div>

<div class="filter-bar">
  <input type="text" id="searchInput" placeholder="Search expressions...">
  <select id="formSelect"><option value="">All forms</option></select>
  <button onclick="exportCSV()">Export CSV</button>
  <span class="clear-btn" id="clearBtn" style="display:none" onclick="clearFilters()">Clear filters</span>
</div>

<div class="section-title" id="sectionTitle">Recent primes</div>
<table>
  <thead>
    <tr>
      <th onclick="toggleSort('expression')">Expression<span class="sort-indicator" id="sort-expression"></span></th>
      <th onclick="toggleSort('form')">Form<span class="sort-indicator" id="sort-form"></span></th>
      <th onclick="toggleSort('digits')">Digits<span class="sort-indicator" id="sort-digits"></span></th>
      <th onclick="toggleSort('found_at')">Found<span class="sort-indicator" id="sort-found_at"></span></th>
    </tr>
  </thead>
  <tbody id="primesBody">
    <tr><td colspan="4" class="empty">Waiting for data...</td></tr>
  </tbody>
</table>
<div class="pagination">
  <button id="prevBtn" disabled onclick="prevPage()">Previous</button>
  <span class="info" id="pageInfo"></span>
  <button id="nextBtn" disabled onclick="nextPage()">Next</button>
</div>

<script>
var LIMIT = 50;
var offset = 0;
var total = 0;
var ws = null;
var reconnectTimer = null;
var sortBy = '';
var sortDir = '';
var filterForm = '';
var filterSearch = '';
var searchDebounceTimer = null;
var hasActiveFilter = false;
var knownForms = [];

function formatTime(iso) {
  if (!iso) return '-';
  return new Date(iso).toLocaleString();
}

function numberWithCommas(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function buildFilterMsg() {
  var msg = { action: 'get_primes', offset: offset, limit: LIMIT };
  if (filterForm) msg.form = filterForm;
  if (filterSearch) msg.search = filterSearch;
  if (sortBy) { msg.sort_by = sortBy; msg.sort_dir = sortDir || 'desc'; }
  return msg;
}

function isFilterActive() {
  return !!(filterForm || filterSearch || sortBy);
}

function updateFilterUI() {
  hasActiveFilter = isFilterActive();
  document.getElementById('clearBtn').style.display = hasActiveFilter ? 'inline' : 'none';
  document.getElementById('sectionTitle').textContent = hasActiveFilter ? 'Filtered primes' : 'Recent primes';
  // Update sort indicators
  ['expression','form','digits','found_at'].forEach(function(col) {
    var el = document.getElementById('sort-' + col);
    if (sortBy === col) {
      el.textContent = sortDir === 'asc' ? ' \u2191' : ' \u2193';
    } else {
      el.textContent = '';
    }
  });
}

function applyFilter() {
  offset = 0;
  updateFilterUI();
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(buildFilterMsg()));
  }
}

function toggleSort(col) {
  if (sortBy === col) {
    if (sortDir === 'asc') {
      sortDir = 'desc';
    } else {
      sortBy = '';
      sortDir = '';
    }
  } else {
    sortBy = col;
    sortDir = 'asc';
  }
  applyFilter();
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('formSelect').value = '';
  filterSearch = '';
  filterForm = '';
  sortBy = '';
  sortDir = '';
  applyFilter();
}

function exportCSV() {
  var params = new URLSearchParams();
  params.set('format', 'csv');
  if (filterForm) params.set('form', filterForm);
  if (filterSearch) params.set('search', filterSearch);
  if (sortBy) { params.set('sort_by', sortBy); params.set('sort_dir', sortDir || 'desc'); }
  window.open('/api/export?' + params.toString(), '_blank');
}

document.getElementById('searchInput').addEventListener('input', function() {
  clearTimeout(searchDebounceTimer);
  var val = this.value;
  searchDebounceTimer = setTimeout(function() {
    filterSearch = val;
    applyFilter();
  }, 300);
});

document.getElementById('formSelect').addEventListener('change', function() {
  filterForm = this.value;
  applyFilter();
});

function renderStats(stats) {
  document.getElementById('totalPrimes').textContent = numberWithCommas(stats.total);
  if (stats.largest_expression) {
    document.getElementById('largestDigits').textContent = numberWithCommas(stats.largest_digits) + ' digits';
    document.getElementById('largestExpr').textContent = stats.largest_expression;
  } else {
    document.getElementById('largestDigits').textContent = '-';
    document.getElementById('largestExpr').textContent = '';
  }
  var tags = document.getElementById('formTags');
  if (stats.by_form.length === 0) {
    tags.textContent = '-';
  } else {
    tags.innerHTML = stats.by_form.map(function(f) {
      return '<span class="form-tag">' + escapeHtml(f.form) + '<span class="count">' + f.count + '</span></span>';
    }).join('');
  }
  // Populate form select if new forms appear
  var newForms = stats.by_form.map(function(f) { return f.form; });
  if (JSON.stringify(newForms) !== JSON.stringify(knownForms)) {
    knownForms = newForms;
    var sel = document.getElementById('formSelect');
    var current = sel.value;
    sel.innerHTML = '<option value="">All forms</option>';
    knownForms.forEach(function(form) {
      var opt = document.createElement('option');
      opt.value = form;
      opt.textContent = form;
      sel.appendChild(opt);
    });
    sel.value = current;
  }
}

function renderPrimes(data) {
  total = data.total;
  offset = data.offset;
  var tbody = document.getElementById('primesBody');
  if (data.primes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="empty">No primes found yet</td></tr>';
  } else {
    tbody.innerHTML = data.primes.map(function(p) {
      return '<tr>' +
      '<td class="expression">' + escapeHtml(p.expression) + '</td>' +
      '<td><span class="form-badge">' + escapeHtml(p.form) + '</span></td>' +
      '<td>' + numberWithCommas(p.digits) + '</td>' +
      '<td>' + formatTime(p.found_at) + '</td>' +
      '</tr>';
    }).join('');
  }
  updatePagination();
}

function renderStatus(data) {
  var dot = document.getElementById('statusDot');
  var text = document.getElementById('statusText');
  if (data.active && data.checkpoint) {
    dot.className = 'status-dot active';
    var cp = data.checkpoint;
    var detail = '';
    if (cp.type === 'Factorial') detail = 'Factorial search at n=' + cp.last_n;
    else if (cp.type === 'Palindromic') detail = 'Palindromic search at ' + cp.digit_count + ' digits';
    else if (cp.type === 'Kbn') detail = 'k*b^n search at n=' + cp.last_n;
    else detail = 'Search in progress';
    text.innerHTML = '<strong>Active:</strong> ' + detail;
  } else {
    dot.className = 'status-dot idle';
    text.innerHTML = '<strong>Idle</strong> â€” no active search';
  }
}

function updatePagination() {
  var start = total === 0 ? 0 : offset + 1;
  var end = Math.min(offset + LIMIT, total);
  document.getElementById('pageInfo').textContent = start + '-' + end + ' of ' + numberWithCommas(total);
  document.getElementById('prevBtn').disabled = offset === 0;
  document.getElementById('nextBtn').disabled = offset + LIMIT >= total;
}

function prevPage() {
  offset = Math.max(0, offset - LIMIT);
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(buildFilterMsg()));
  }
}

function nextPage() {
  if (offset + LIMIT < total) {
    offset += LIMIT;
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(buildFilterMsg()));
    }
  }
}

function setConnected(ok) {
  document.getElementById('connDot').className = 'conn-dot ' + (ok ? 'ok' : 'off');
  document.getElementById('connLabel').textContent = ok ? 'Connected' : 'Reconnecting...';
}

function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws');

  ws.onopen = function() { setConnected(true); };

  ws.onclose = function() {
    setConnected(false);
    ws = null;
    reconnectTimer = setTimeout(connect, 3000);
  };

  ws.onerror = function() { ws.close(); };

  ws.onmessage = function(e) {
    var data = JSON.parse(e.data);
    if (data.type === 'update') {
      renderStats(data.stats);
      renderStatus(data.status);
      if (!hasActiveFilter) {
        renderPrimes(data.primes);
      }
    } else if (data.type === 'primes') {
      renderPrimes(data);
    }
  };
}

connect();
</script>
</body>
</html>
